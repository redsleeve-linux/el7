From 9d32e518cdabe03c6c8f9ff462b17205f444329a Mon Sep 17 00:00:00 2001
From: Jacco Ligthart <jacco@redsleeve.org>
Date: Sun, 20 May 2018 09:44:09 +0200
Subject: [PATCH] small changes to build/test on armv5

---
 SOURCES/qemu_less_qtest-arm_tests.patch            | 21 +++++++++++++++++++++
 .../qemu_reenable_register_for_arm-softmmu.patch   | 12 ++++++++++++
 SPECS/qemu-kvm.spec                                | 22 +++++++++++++++++++---
 3 files changed, 52 insertions(+), 3 deletions(-)
 create mode 100644 SOURCES/qemu_less_qtest-arm_tests.patch
 create mode 100644 SOURCES/qemu_reenable_register_for_arm-softmmu.patch

diff --git a/SOURCES/qemu_less_qtest-arm_tests.patch b/SOURCES/qemu_less_qtest-arm_tests.patch
new file mode 100644
index 0000000..0f77d9d
--- /dev/null
+++ b/SOURCES/qemu_less_qtest-arm_tests.patch
@@ -0,0 +1,21 @@
+--- a/tests/Makefile.include	2018-02-20 19:41:07.624205352 +0100
++++ b/tests/Makefile.include	2018-02-20 19:48:53.453680881 +0100
+@@ -323,13 +323,13 @@
+ #gcov-files-sparc64-y += hw/timer/m48t59.c
+ check-qtest-sparc64-y += tests/prom-env-test$(EXESUF)
+ 
+-check-qtest-arm-y = tests/tmp105-test$(EXESUF)
+-check-qtest-arm-y += tests/ds1338-test$(EXESUF)
+-check-qtest-arm-y += tests/m25p80-test$(EXESUF)
++#check-qtest-arm-y = tests/tmp105-test$(EXESUF)
++#check-qtest-arm-y += tests/ds1338-test$(EXESUF)
++#check-qtest-arm-y += tests/m25p80-test$(EXESUF)
+ gcov-files-arm-y += hw/misc/tmp105.c
+-check-qtest-arm-y += tests/virtio-blk-test$(EXESUF)
++check-qtest-arm-y = tests/virtio-blk-test$(EXESUF)
+ gcov-files-arm-y += arm-softmmu/hw/block/virtio-blk.c
+-check-qtest-arm-y += tests/test-arm-mptimer$(EXESUF)
++#check-qtest-arm-y += tests/test-arm-mptimer$(EXESUF)
+ gcov-files-arm-y += hw/timer/arm_mptimer.c
+ 
+ #check-qtest-aarch64-y = tests/numa-test$(EXESUF)
diff --git a/SOURCES/qemu_reenable_register_for_arm-softmmu.patch b/SOURCES/qemu_reenable_register_for_arm-softmmu.patch
new file mode 100644
index 0000000..f70b804
--- /dev/null
+++ b/SOURCES/qemu_reenable_register_for_arm-softmmu.patch
@@ -0,0 +1,12 @@
+--- a/hw/core/Makefile.objs	2018-02-20 06:44:30.029587435 +0100
++++ b/hw/core/Makefile.objs	2018-02-20 06:42:50.434759721 +0100
+@@ -16,8 +16,8 @@
+ common-obj-$(CONFIG_FITLOADER) += loader-fit.o
+ common-obj-$(CONFIG_SOFTMMU) += qdev-properties-system.o
+ common-obj-$(CONFIG_PLATFORM_BUS) += platform-bus.o
++common-obj-$(CONFIG_SOFTMMU) += register.o
+ # Disabled in Red Hat Enterprise Linux
+-# common-obj-$(CONFIG_SOFTMMU) += register.o
+ # obj-$(CONFIG_SOFTMMU) += generic-loader.o
+ # common-obj-$(CONFIG_SOFTMMU) += or-irq.o
+ 
diff --git a/SPECS/qemu-kvm.spec b/SPECS/qemu-kvm.spec
index 9f7889a..5a95704 100644
--- a/SPECS/qemu-kvm.spec
+++ b/SPECS/qemu-kvm.spec
@@ -19,7 +19,7 @@
     %global have_usbredir 0
 %endif
 
-%ifnarch s390 s390x
+%ifnarch s390 s390x %{arm}
     %global have_librdma 1
     %global have_tcmalloc 1
 %else
@@ -54,6 +54,11 @@
     %global kvm_target    aarch64
     %global have_fdt     1
 %endif
+%ifarch %{arm}
+    %global kvm_target    arm
+    %global have_fdt     1
+%endif
+
 
 #Versions of various parts:
 
@@ -106,7 +111,7 @@ Obsoletes: %1%{rhel_ma_suffix} < %{obsoletes_version2}                 \
 Summary: QEMU is a machine emulator and virtualizer
 Name: %{pkgname}%{?pkgsuffix}
 Version: 2.10.0
-Release: 21%{?dist}.2
+Release: 21%{?dist}.2.redsleeve
 # Epoch because we pushed a qemu-1.0 package. AIUI this can't ever be dropped
 Epoch: 10
 License: GPLv2+ and LGPLv2+ and BSD
@@ -115,7 +120,7 @@ URL: http://www.qemu.org/
 %if %{rhev}
 ExclusiveArch: x86_64 %{power64} aarch64 s390x
 %else
-ExclusiveArch: %{power64} aarch64 s390x
+ExclusiveArch: %{power64} aarch64 s390x %{arm}
 %endif
 %ifarch %{ix86} x86_64
 Requires: seabios-bin >= 1.10.2-1
@@ -1058,6 +1063,9 @@ Patch451: kvm-vga-add-ram_addr_t-cast.patch
 # For bz#1566878 - CVE-2018-7858 qemu-kvm-ma: Qemu: cirrus: OOB access when updating vga display [rhel-7] [rhel-7.5.z]
 Patch452: kvm-vga-fix-region-calculation.patch
 
+Patch1000: qemu_reenable_register_for_arm-softmmu.patch
+Patch1001: qemu_less_qtest-arm_tests.patch
+
 BuildRequires: zlib-devel
 BuildRequires: glib2-devel
 BuildRequires: which
@@ -1687,6 +1695,9 @@ cp %{SOURCE29} pc-bios
 %patch451 -p1
 %patch452 -p1
 
+%patch1000 -p1
+%patch1001 -p1
+
 # for tscdeadline_latency.flat
 %ifarch x86_64
   tar -xf %{SOURCE25}
@@ -2184,6 +2195,11 @@ useradd -r -u 107 -g qemu -G kvm -d / -s /sbin/nologin \
 %endif
 
 %changelog
+* Sun May 20 2018 Jacco Ligthart <jacco@redsleeve.org> - 2.10.0-21.el7.2.redsleeve
+- added kvm_target arm
+- do not use rdma-core
+- small patches to Makefiles
+
 * Fri Apr 13 2018 Miroslav Rezanina <mrezanin@redhat.com> - ma-2.10.0-21.el7_5.2
 - kvm-block-Fix-flags-in-reopen-queue.patch [bz#1557206]
 - kvm-iotests-Add-regression-test-for-commit-base-locking.patch [bz#1557206]
-- 
1.8.3.1

