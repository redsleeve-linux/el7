From 6a90128f2bb5e26366fcf82546c07401037695c5 Mon Sep 17 00:00:00 2001
From: Jacco Ligthart <jacco@redsleeve.org>
Date: Sun, 15 Apr 2018 15:47:39 +0200
Subject: [PATCH] patched for arm

---
 SOURCES/webkitgtk4-arm-no-atomic.patch | 26 ++++++++++++++++++++++++++
 SPECS/webkitgtk4.spec                  | 17 +++++++++++++----
 2 files changed, 39 insertions(+), 4 deletions(-)
 create mode 100644 SOURCES/webkitgtk4-arm-no-atomic.patch

diff --git a/SOURCES/webkitgtk4-arm-no-atomic.patch b/SOURCES/webkitgtk4-arm-no-atomic.patch
new file mode 100644
index 0000000..69be087
--- /dev/null
+++ b/SOURCES/webkitgtk4-arm-no-atomic.patch
@@ -0,0 +1,26 @@
+--- a/Source/WTF/wtf/CMakeLists.txt	
++++ a/Source/WTF/wtf/CMakeLists.txt	
+@@ -182,7 +182,6 @@
+ 
+ set(WTF_SOURCES
+     Assertions.cpp
+-    Atomics.cpp
+     AutomaticThread.cpp
+     BitVector.cpp
+     ClockType.cpp
+@@ -304,6 +303,15 @@
+     list(APPEND WTF_LIBRARIES bmalloc)
+ endif ()
+ 
++file(WRITE ${CMAKE_BINARY_DIR}/test_atomics.cpp
++     "int main(void)\n"
++     "{ long long x = 1; return (int) __sync_add_and_fetch_8(&x, 1); }\n")
++try_compile(ATOMICS_BUILD_SUCCEEDED ${CMAKE_BINARY_DIR} ${CMAKE_BINARY_DIR}/test_atomics.cpp)
++if (NOT ATOMICS_BUILD_SUCCEEDED)
++    list(APPEND WTF_SOURCES Atomics.cpp)
++endif ()
++file(REMOVE ${CMAKE_BINARY_DIR}/test_atomics.cpp)
++
+ list(APPEND WTF_SOURCES
+     unicode/icu/CollatorICU.cpp
+ )
diff --git a/SPECS/webkitgtk4.spec b/SPECS/webkitgtk4.spec
index 36683b3..9cc0978 100644
--- a/SPECS/webkitgtk4.spec
+++ b/SPECS/webkitgtk4.spec
@@ -27,7 +27,7 @@
 
 Name:           webkitgtk4
 Version:        2.16.6
-Release:        6%{?dist}
+Release:        6%{?dist}.redsleeve
 Summary:        GTK+ Web content engine library
 
 License:        LGPLv2
@@ -92,6 +92,8 @@ Patch58: icu-dont_use_clang_even_if_installed.patch
 Patch59: icu-rhbz1444101-icu-changeset-39671.patch
 %endif
 
+Patch1000: webkitgtk4-arm-no-atomic.patch
+
 BuildRequires:  at-spi2-core-devel
 BuildRequires:  bison
 BuildRequires:  cairo-devel
@@ -254,6 +256,8 @@ Support for the GTK+ 2 based NPAPI plugins (such as Adobe Flash) for %{name}.
 %autosetup -p1 -n webkitgtk-%{version}
 %endif
 
+%patch1000 -p1
+
 # Remove bundled libraries
 rm -rf Source/ThirdParty/gtest/
 rm -rf Source/ThirdParty/qunit/
@@ -343,13 +347,13 @@ pushd %{_target_platform}
 %endif
   -DENABLE_GTKDOC=ON \
   -DENABLE_MINIBROWSER=ON \
-%ifarch s390 aarch64
+%ifarch s390 aarch64 %{arm}
   -DUSE_LD_GOLD=OFF \
 %endif
-%ifarch s390 s390x ppc %{power64} aarch64 %{mips}
+%ifarch s390 s390x ppc %{power64} aarch64 %{mips} %{arm}
   -DENABLE_JIT=OFF \
 %endif
-%ifarch s390 s390x ppc %{power64} aarch64 %{mips}
+%ifarch s390 s390x ppc %{power64} aarch64 %{mips} %{arm}
   -DUSE_SYSTEM_MALLOC=ON \
 %endif
   ..
@@ -449,6 +453,11 @@ chmod 644 $RPM_BUILD_ROOT%{_libdir}/webkit2gtk-4.0/libicuuc.so.57.1
 %{_datadir}/gtk-doc/html/webkitdomgtk-4.0/
 
 %changelog
+* Sun Apr 15 2018 Jacco Ligthart <jacco@redsleeve.com> - 2.16.6-6.redsleeve
+- disabled LD_GOLD4, JIT for arm
+- use system malloc for arm
+- added a patch: https://bugs.webkit.org/show_bug.cgi?id=161900
+
 * Wed Nov 08 2017 Tomas Popela <tpopela@redhat.com> - 2.16.6-6
 - Don't strip debug info from bundled icu libraries, otherwise there
   will be conflicts between webkitgtk4-debuginfo and icu-debuginfo packages
-- 
1.8.3.1

