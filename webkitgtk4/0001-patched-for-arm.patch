From ec302235bcf76326707d5248f5e87345582febcc Mon Sep 17 00:00:00 2001
From: Jacco Ligthart <jacco@redsleeve.org>
Date: Fri, 1 Dec 2017 14:00:53 +0100
Subject: [PATCH] patched for arm

---
 SOURCES/webkitgtk4-arm-no-atomic.patch | 26 ++++++++++++++++++++++++++
 SPECS/webkitgtk4.spec                  | 17 +++++++++++++----
 2 files changed, 39 insertions(+), 4 deletions(-)
 create mode 100644 SOURCES/webkitgtk4-arm-no-atomic.patch

diff --git a/SOURCES/webkitgtk4-arm-no-atomic.patch b/SOURCES/webkitgtk4-arm-no-atomic.patch
new file mode 100644
index 0000000..848245f
--- /dev/null
+++ b/SOURCES/webkitgtk4-arm-no-atomic.patch
@@ -0,0 +1,26 @@
+--- a/Source/WTF/wtf/CMakeLists.txt	
++++ a/Source/WTF/wtf/CMakeLists.txt	
+@@ -171,7 +171,6 @@ set(WTF_HEADERS
+ 
+ set(WTF_SOURCES
+     Assertions.cpp
+-    Atomics.cpp
+     BitVector.cpp
+     CompilationThread.cpp
+     CrossThreadCopier.cpp
+@@ -276,6 +275,15 @@ if (NOT USE_SYSTEM_MALLOC)
+     list(APPEND WTF_LIBRARIES bmalloc)
+ endif ()
+ 
++file(WRITE ${CMAKE_BINARY_DIR}/test_atomics.cpp
++     "int main(void)\n"
++     "{ long long x = 1; return (int) __sync_add_and_fetch_8(&x, 1); }\n")
++try_compile(ATOMICS_BUILD_SUCCEEDED ${CMAKE_BINARY_DIR} ${CMAKE_BINARY_DIR}/test_atomics.cpp)
++if (NOT ATOMICS_BUILD_SUCCEEDED)
++    list(APPEND WTF_SOURCES Atomics.cpp)
++endif ()
++file(REMOVE ${CMAKE_BINARY_DIR}/test_atomics.cpp)
++
+ list(APPEND WTF_SOURCES
+     unicode/icu/CollatorICU.cpp
+ )
diff --git a/SPECS/webkitgtk4.spec b/SPECS/webkitgtk4.spec
index 329ffa8..06fe8d7 100644
--- a/SPECS/webkitgtk4.spec
+++ b/SPECS/webkitgtk4.spec
@@ -18,7 +18,7 @@
 
 Name:           webkitgtk4
 Version:        2.14.7
-Release:        3%{?dist}
+Release:        3%{?dist}.redsleeve
 Summary:        GTK+ Web content engine library
 
 License:        LGPLv2
@@ -101,6 +101,8 @@ Patch57: icu-diff-icu_trunk_source_common_locid.cpp-from-39282-to-39384.patch
 Patch58: icu-dont_use_clang_even_if_installed.patch
 %endif
 
+Patch1000: webkitgtk4-arm-no-atomic.patch
+
 BuildRequires:  at-spi2-core-devel
 BuildRequires:  bison
 BuildRequires:  cairo-devel
@@ -272,6 +274,8 @@ Support for the GTK+ 2 based NPAPI plugins (such as Adobe Flash) for %{name}.
 %autosetup -p1 -n webkitgtk-%{version}
 %endif
 
+%patch1000 -p1
+
 # Remove bundled libraries
 rm -rf Source/ThirdParty/gtest/
 rm -rf Source/ThirdParty/qunit/
@@ -359,13 +363,13 @@ pushd %{_target_platform}
 %endif
   -DENABLE_GTKDOC=ON \
   -DENABLE_MINIBROWSER=ON \
-%ifarch s390 aarch64
+%ifarch s390 aarch64 %{arm}
   -DUSE_LD_GOLD=OFF \
 %endif
-%ifarch s390 s390x ppc %{power64} aarch64 %{mips}
+%ifarch s390 s390x ppc %{power64} aarch64 %{mips} %{arm}
   -DENABLE_JIT=OFF \
 %endif
-%ifarch s390 s390x ppc %{power64} aarch64 %{mips}
+%ifarch s390 s390x ppc %{power64} aarch64 %{mips} %{arm}
   -DUSE_SYSTEM_MALLOC=ON \
 %endif
   ..
@@ -452,6 +456,11 @@ popd
 %{_datadir}/gtk-doc/html/webkitdomgtk-4.0/
 
 %changelog
+* Fri Dec 01 2017 Jacco Ligthart <jacco@redsleeve.com> - 2.14.7-3.redsleeve
+- disabled LD_GOLD4, JIT for arm
+- use system malloc for arm
+- added a patch: https://bugs.webkit.org/show_bug.cgi?id=161900
+
 * Mon Oct 09 2017 Tomas Popela <tpopela@redhat.com> - 2.14.7-3
 - Update the bundled brotli and woff2 to the latest releases due to
   woff2's license incompatibility with WebKitGTK+ project
-- 
1.8.3.1

