From 000869de9fabb90082dd1577610a04b545cdbf77 Mon Sep 17 00:00:00 2001
Message-Id: <000869de9fabb90082dd1577610a04b545cdbf77@dist-git>
From: Martin Kletzander <mkletzan@redhat.com>
Date: Mon, 23 Nov 2015 12:46:36 +0100
Subject: [PATCH] RHEL: qemu: Support vhost-user-multiqueue with QEMU 2.3

RHEL-only

Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=1207692
Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=1284416

Signed-off-by: Martin Kletzander <mkletzan@redhat.com>
Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
---
 src/qemu/qemu_capabilities.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/qemu/qemu_capabilities.c b/src/qemu/qemu_capabilities.c
index 206133d..9f1c0e1 100644
--- a/src/qemu/qemu_capabilities.c
+++ b/src/qemu/qemu_capabilities.c
@@ -3529,8 +3529,11 @@ virQEMUCapsInitQMPMonitor(virQEMUCapsPtr qemuCaps,
         virQEMUCapsSet(qemuCaps, QEMU_CAPS_CPU_AARCH64_OFF);
 
     /* vhost-user supports multi-queue from v2.4.0 onwards,
-     * but there is no way to query for that capability */
-    if (qemuCaps->version >= 2004000)
+     * but there is no way to query for that capability
+     *
+     * RHEL-only: The change was back-ported to earlier QEMU version,
+     * particularly 2.3, in BZ 1276100 */
+    if (qemuCaps->version >= 2003000)
         virQEMUCapsSet(qemuCaps, QEMU_CAPS_VHOSTUSER_MULTIQUEUE);
 
     /* Since 2.4.50 ARM virt machine supports gic-version option */
-- 
2.9.0

