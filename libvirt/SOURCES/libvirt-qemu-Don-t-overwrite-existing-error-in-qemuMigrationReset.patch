From 28079e51b504ad2e5849d38dc994c41d319bf133 Mon Sep 17 00:00:00 2001
Message-Id: <28079e51b504ad2e5849d38dc994c41d319bf133@dist-git>
From: Jiri Denemark <jdenemar@redhat.com>
Date: Thu, 6 Apr 2017 09:23:18 +0200
Subject: [PATCH] qemu: Don't overwrite existing error in qemuMigrationReset

https://bugzilla.redhat.com/show_bug.cgi?id=1439130

Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
(cherry picked from commit 45b639bdbabe59056a6fc89ee4189fe695d6fae2)
Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
---
 src/qemu/qemu_migration.c | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/src/qemu/qemu_migration.c b/src/qemu/qemu_migration.c
index ae0ab368d..8c6d1385e 100644
--- a/src/qemu/qemu_migration.c
+++ b/src/qemu/qemu_migration.c
@@ -5871,15 +5871,22 @@ qemuMigrationReset(virQEMUDriverPtr driver,
                    qemuDomainAsyncJob job)
 {
     qemuMonitorMigrationCaps cap;
+    virErrorPtr err = virSaveLastError();
 
     if (!virDomainObjIsActive(vm))
-        return;
+        goto cleanup;
 
     if (qemuMigrationResetTLS(driver, vm, job) < 0)
-        return;
+        goto cleanup;
 
     for (cap = 0; cap < QEMU_MONITOR_MIGRATION_CAPS_LAST; cap++) {
         if (qemuMigrationSetOption(driver, vm, cap, false, job) < 0)
-            return;
+            goto cleanup;
+    }
+
+ cleanup:
+    if (err) {
+        virSetError(err);
+        virFreeError(err);
     }
 }
-- 
2.12.2

