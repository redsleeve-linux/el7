From c18a7bad7e9e16ebec10bcbbd4707d0f2203a856 Mon Sep 17 00:00:00 2001
From: Jacco Ligthart <jacco@redsleeve.org>
Date: Tue, 13 Dec 2016 21:51:32 +0100
Subject: [PATCH] add a patch to be able to build the tests

---
 ...inktest:-also-build-virAtomic.h-redsleeve.patch | 43 ++++++++++++++++++++++
 SPECS/libvirt.spec                                 |  6 ++-
 2 files changed, 48 insertions(+), 1 deletion(-)
 create mode 100644 SOURCES/libvirt-tests-nsslinktest:-also-build-virAtomic.h-redsleeve.patch

diff --git a/SOURCES/libvirt-tests-nsslinktest:-also-build-virAtomic.h-redsleeve.patch b/SOURCES/libvirt-tests-nsslinktest:-also-build-virAtomic.h-redsleeve.patch
new file mode 100644
index 0000000..363c78a
--- /dev/null
+++ b/SOURCES/libvirt-tests-nsslinktest:-also-build-virAtomic.h-redsleeve.patch
@@ -0,0 +1,43 @@
+From 7e1ca80d87c2918eb579c589ea306de88c9d9ad6 Mon Sep 17 00:00:00 2001
+From: Kai Kang <kai.kang@windriver.com>
+Date: Mon, 8 Aug 2016 09:53:47 +0800
+Subject: [PATCH] nsslinktest: also build virAtomic.h
+
+When build for architecture that don't use gcc atomic ops but pthread,
+it fails to build for armel:
+
+| ../tools/nss/.libs/libnss_libvirt_impl.a(libvirt_nss_la-virobject.o): In function `virClassNew':
+| /buildarea2/kkang/builds/qemuarm-Aug03/bitbake_build/tmp/work/armv5e-wrs-linux-gnueabi/libvirt/1.3.5-r0/build/src/../../libvirt-1.3.5/src/util/virobject.c:153: undefined reference to `virAtomicLock'
+| ../tools/nss/.libs/libnss_libvirt_impl.a(libvirt_nss_la-virobject.o): In function `virObjectNew':
+| /buildarea2/kkang/builds/qemuarm-Aug03/bitbake_build/tmp/work/armv5e-wrs-linux-gnueabi/libvirt/1.3.5-r0/build/src/../../libvirt-1.3.5/src/util/virobject.c:205: undefined reference to `virAtomicLock'
+| ../tools/nss/.libs/libnss_libvirt_impl.a(libvirt_nss_la-virobject.o): In function `virObjectUnref':
+| /buildarea2/kkang/builds/qemuarm-Aug03/bitbake_build/tmp/work/armv5e-wrs-linux-gnueabi/libvirt/1.3.5-r0/build/src/../../libvirt-1.3.5/src/util/virobject.c:277: undefined reference to `virAtomicLock'
+| ../tools/nss/.libs/libnss_libvirt_impl.a(libvirt_nss_la-virobject.o): In function `virObjectRef':
+| /buildarea2/kkang/builds/qemuarm-Aug03/bitbake_build/tmp/work/armv5e-wrs-linux-gnueabi/libvirt/1.3.5-r0/build/src/../../libvirt-1.3.5/src/util/virobject.c:298: undefined reference to `virAtomicLock'
+| collect2: error: ld returned 1 exit status
+
+It is similar with:
+
+http://libvirt.org/git/?p=libvirt.git;a=commit;h=12dc729
+
+Signed-off-by: Kai Kang <kai.kang@windriver.com>
+---
+ src/Makefile.am |    2 ++
+ 1 files changed, 2 insertions(+), 0 deletions(-)
+
+diff --git a/src/Makefile.am b/src/Makefile.am
+index 4416390..922b9b8 100644
+--- a/src/Makefile.am
++++ b/src/Makefile.am
+@@ -2997,6 +2997,8 @@ noinst_LTLIBRARIES += libvirt-nss.la
+ libvirt_nss_la_SOURCES =		\
+ 		util/viralloc.c			\
+ 		util/viralloc.h			\
++		util/viratomic.c		\
++		util/viratomic.h		\
+ 		util/virbitmap.c		\
+ 		util/virbitmap.h		\
+ 		util/virbuffer.c		\
+-- 
+1.7.1
+
diff --git a/SPECS/libvirt.spec b/SPECS/libvirt.spec
index 438ff4b..5413160 100644
--- a/SPECS/libvirt.spec
+++ b/SPECS/libvirt.spec
@@ -217,7 +217,7 @@
 Summary: Library providing a simple virtualization API
 Name: libvirt
 Version: 2.0.0
-Release: 10%{?dist}.2%{?extra_release}
+Release: 10%{?dist}.2%{?extra_release}.redsleeve
 License: LGPLv2+
 Group: Development/Libraries
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
@@ -488,6 +488,7 @@ Patch256: libvirt-qemu-Add-support-for-hot-cold-un-plug-of-shmem-devices.patch
 Patch257: libvirt-qemu-Fix-double-free-when-live-attaching-shmem.patch
 Patch258: libvirt-qemu-Make-sure-shmem-memory-is-shared.patch
 
+Patch1000: libvirt-tests-nsslinktest:-also-build-virAtomic.h-redsleeve.patch
 
 Requires: libvirt-daemon = %{version}-%{release}
 Requires: libvirt-daemon-config-network = %{version}-%{release}
@@ -2129,6 +2130,9 @@ exit 0
 
 
 %changelog
+* Sun Dec 11 2016 Jacco Ligthart <jacco@redsleeve.org> - 2.0.0-10.2.redsleeve
+- add a patch to be able to build the tests
+
 * Thu Nov 10 2016 Jiri Denemark <jdenemar@redhat.com> - 2.0.0-10.el7_3.2
 - qemu: Fix double free when live-attaching shmem (rhbz#1392031)
 - qemu: Make sure shmem memory is shared (rhbz#1392031)
-- 
1.8.3.1

